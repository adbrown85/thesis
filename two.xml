<scene>

    <clear color="0 0 0 0" />

    <!-- Color shader program -->
    <program id="color-program">
        <shader type="vertex" file="basic.vert" />
        <shader type="fragment" file="basic.frag" />
        <attribute name="MCVertex" usage="point" location="0" />
    </program>

    <!-- Texture coordinate shader program -->
    <program id="coords-program">
        <shader type="vertex" file="coords.vert" />
        <shader type="fragment" file="coords.frag" />
        <attribute name="MCVertex" usage="point" location="0" />
        <attribute name="TexCoord0" usage="coordinate" location="1" />
    </program>

    <!-- Allocate render buffers -->
    <renderbuffer id="my-color-buffer" format="rgba" width="768" height="768" />
    <renderbuffer id="my-depth-buffer" format="depth" width="768" height="768" />

    <!-- Create and bind textures -->
    <texture id="volume" file="bunny.vlb">
    <texture id="back-faces-texture" size="768">

        <framebuffer>
            <attachment type="renderbuffer" usage="depth" link="back-faces-texture" />

        </framebuffer>

    <!--
       Clear the depth buffer to one and then prime the depth buffer with the back faces
       of the intersection.  That way when the depth function is set to 'greater', only
       the things behind the intersection will render.

       If we draw the coordinates here instead of just a color, we'll be able to render
       one of the volumes.
     -->
    <clear depth="1" />
    <depth function="less" />
    <cull mode="front" />
    <polygon mode="fill" />
    <use program="color-program">
        <uniform type="mat4" name="MVPMatrix" usage="viewprojection" />
        <uniform type="vec4" name="Color" value="0 0 1 1" />
        <boolean of="c1 c2" />
    </use>

    <!--
       Set the depth function to 'greater' and then draw the back faces of the cubes.
       Since the depth buffer was primed with the back faces of the intersection, only
       the fragments behind that should render.
     -->
    <depth function="greater" />
    <cull mode="front" />
    <polygon mode="fill" />
    <use program="coords-program">
        <group id="cubes">
            <translate x="-1">
                <uniform type="mat4" name="MVPMatrix" usage="modelviewprojection" />
                <uniform type="vec4" name="Color" value="1 0 0 1" />
                <cube id="c1" />
            </translate>
            <translate x="+1">
                <uniform type="mat4" name="MVPMatrix" usage="modelviewprojection" />
                <uniform type="vec4" name="Color" value="0 1 0 1" />
                <cube id="c2" />
            </translate>
        </group>
    </use>

    <!-- Unbind textures -->
    </texture>
    </texture>


    <!-- Draw outlines -->
    <depth function="less" />
    <polygon mode="line" />
    <cull mode="none" />
    <use program="color">
        <instance link="cubes" />
    </use>

</scene>
